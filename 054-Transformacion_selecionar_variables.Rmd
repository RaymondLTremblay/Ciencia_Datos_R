# Transformacion 5

Fecha de la ultima revisión
```{r echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

Sys.Date()
```

##  Funciones en este módulo

  - starts_with() # selecciona variables que empiezan con una palabra o letra
  - ends_with() # selecciona variables que terminan con una palabra o letra
  - rename() # cambiar el nombre de una variable
  - contains() # selecciona variables que contienen una palabra o letra
  - everything() # selecciona todas las variables
  - if_else() # reemplaza valores en una columna basado en una condición

Es una función para seleccionar basado en una caracteristicas del nombre de la columna

```{r}
library(datos)
names(vuelos)
library(tidyverse)
vuelos %>% 
  dplyr::select(horario_salida)

vuelos %>% 
  dplyr::select(starts_with("horario"))

vuelos %>% 
  dplyr::select(ends_with("salida"))

vuelos %>% 
  dplyr::select(contains("salida"))

```

## rename()

Cambiar el nombre de la columna

```{r}
vuelos %>% 
  rename(aeropuerto_origen=origen) %>% 
  rename(areopuerto_distino=destino) # nombre nuevo= nombre original
```

## Reoganizar el orden de las columnas, usando select() y everything() en la misma función

```{r}
head(vuelos)
vuelos %>% 
    dplyr::select(distancia, aerolinea, everything())
```

Seleccionar de un conjunto de variables en orden que aparece en el data.frame

```{r}
vuelos |> dplyr::select(anio:horario_salida)
  
```






------------------------------------------------------------------------

3.  **Ejercicios**:

Hacer los ejercicios en la sección 5.4.1 del libro en español

------------------------------------------------------------------------

-   Otras funciones:

    -   mutate()
    
    
```{r}
names(vuelos)
# |> es igual %>% 
new_df=vuelos |> dplyr::select(distancia, tiempo_vuelo, atraso_salida,  atraso_llegada) |> 
  mutate( ganancia = atraso_salida - atraso_llegada,
          velocidad = distancia / tiempo_vuelo * 60)

new_df
```

    
    
## Crear un data frame más pequeño con las variables de interes


```{r}
library(tidyverse)
library(nycflights13)
head(flights)

names(vuelos)
  vuelos_sml <- dplyr::select(vuelos, 
  anio:dia, 
  starts_with("atraso"), 
  distancia, 
  tiempo_vuelo
)
head(vuelos_sml)
```

## Crear nuevas variables

```{r}

mutate(vuelos_sml,
  ganado = atraso_salida - atraso_llegada,
  velocidad = distancia / tiempo_vuelo * 60
)
```



## transmute()

Para guardar solamente la nueva variable usa **transmutate**

```{r}

flights |> transmute(
  gain = dep_delay - arr_delay,
  hours = air_time / 60,
  gain_per_hour = gain / hours
)

```



## lag()

Para calcular diferencias entre variables en la misma columna

```{r}
set.seed(12345) # que los datos sean al azar, siempre sean los mismo, se usa el "set.seed()" para enseñanza.
#rnorm()  DATOS CON DISTRIBUCION NORMAL

data=rpois(14, 10)
df=as_tibble(data)
df

df %>% 
  dplyr::select(value) %>% 
  mutate(lag1=lag(value)) %>% 
  mutate(lag3=lag(value, 3)) %>% 
  mutate(lag7=lag(value,5))

## Calcular la diferencia usando lag

df%>% 
  dplyr::select(value) %>% 
  mutate(lag1=lag(value)) %>% 
  mutate(Changes=value-lag(value, 1)) # El cambio en los valores entre celdas


```

## Usa "Lag" con "IncCasosSaludNuevo" en COVID-19 PR

Evalúa la diferencia en números de casos entre 7 días de las semana en números de casos nuevos de COVID, "IncCasosSaludNuevo"

```{r}
library(readr)
library(dplyr)
#names(url_COVID_PR)
url_COVID_PR <- read_csv("Datos/url_COVID_PR.csv")
#head(url_COVID_PR)
#names(url_COVID_PR)
df2=url_COVID_PR %>% 
  dplyr::select(IncCasosSaludNuevo) %>% 
  mutate(Cambios_Casos=IncCasosSaludNuevo-lag(IncCasosSaludNuevo,7)) 


df2
df2 %>% 
  dplyr::select(IncCasosSaludNuevo, Cambios_Casos) %>% 
  colMeans(na.rm=TRUE)





#df2 %>% 
#  select()
#  slice(na.rm=TRUE) # lets you index rows by their (integer) locations. It allows you to select, remove, and duplicate rows. It is accompanied by a number of helpers for common use cases


```


## lead(),

is the "next" (lead()) values in a vector/column

```{r}
set.seed(12345)
data=rpois(15, 10)
df=as.tibble(data)
df

df %>% 
  dplyr::select(value) %>% 
  mutate(lead1=lead(value)) %>% 
  mutate(lead3=lead(value, 3))

# Calculate the change in value from one (1) time period and four (4) time periods
df%>% 
  dplyr::select(value) %>% 
  mutate(lead1=value-lead(value)) %>% 
  mutate(lead7=value-lead(value, 7))
```

## cumsum

Suma cumulativa: los valores se suman a los largo del vector o columna

```{r}
set.seed(12345) # set.seed() es para que los datos NO sean al azar y se puede replicar los resultados, tipicamente esto se usa para enseñanzar. 


x <- sample(1:15, 10, replace=TRUE) # sample es para seleccionar valores al azar de un vector

x
df=as.tibble(x)
df

df %>% 
  dplyr::select(value) %>% 
  mutate(suma=cumsum(value))




```

```{r}
url_COVID_PR <- read_csv("Datos/url_COVID_PR.csv")

head(url_COVID_PR)

url_COVID_PR %>%
dplyr::select(IncCasosSaludNuevo, CasosSaludNuevo) %>%
mutate(suma=cumsum(IncCasosSaludNuevo))
```




## cummean() and cumvar()

Para calcular el promedio cumulativo y la varianza

 - las funciones son
  - cummean() # del paquete cumstats
  - cumvar() # del paquete cumstats
  
  
  Vea las otras funciones en el paquete cumstats: hay otra que podría usar en sus estudios?

```{r}

set.seed(678)
x <- rnorm(1000, 5, .001)
head(x)
df=as.tibble(x)
head(df)
mean(df$value)


library(MASS)

df3=df %>% 
  dplyr::select(value) %>% 
  mutate(Prom_cum=cummean(value)) %>% 
  mutate(Var_cum=cumstats::cumvar(value)) # activa el paquete cumstats


library(cumstats)
 df3=df %>% 
  dplyr::select(value) %>% 
  mutate(Prom_cum=cummean(value)) %>% 
  mutate(Var_cum=cumvar(value))

 df3


```


## Uso de varianza cumulativa en investigación:

Un metodo para determinar si la cantidad de muestras recolectada es suficiente, es evaluar si la varianza cumulativa sigue cambiando cuando se añade nuevas recolección de datos.   


```{r}
df3$order=c(1:1000)
df3


ggplot(df3, aes(order, Var_cum))+
  geom_point()+
  geom_smooth()
```



## Que pasa con las funciones **cummean**, **cumsum** y **cumvar** si hay NA en el archivo de datos?

### Replacar los NA con 0, usando la función **replace_na()** con un valor especifico **replace_na("variable", 0)**


```{r}
datos_NA=c(1:8, NA, 10:20)
datos_NA=as.data.frame(datos_NA)

datos_NA %>% 
  dplyr::select(datos_NA) %>% 
  mutate(Prom_cum=cummean(datos_NA)) %>% 
  mutate(Var_cum=cumstats::cumvar(datos_NA)) 

# Solución para resolver los NA.   Cual problema hay con usar NA?

```


La función if_else() es una función de reemplazo de valores en una columna basado en una condición



```{r}
library(tidyverse)
library(dplyr)

some_data = tibble(day = 1:10)
some_data


some_data |> 
  mutate(day_p = if_else(day %in% c(0:3), "pre", "normal"))

```




```{r}
plant_repr=tibble(num_flowers=c(0,0,0,0,1,2,0,1,2,0,2, 100, 1000))

plant_repr

plant_repr |> 
  mutate(flower_status = if_else(num_flowers == 0, "not reproductive",
                                 "reproductive"))

plant_repr |> 
  mutate(flower_status = if_else(num_flowers %in% c(0), "not reproductive",
                                 "reproductive"))

plant_repr |>
  mutate(flower_status = 
           if_else(num_flowers %in% c(0), 
                                 "not reproductive",
           if_else(num_flowers %in% c(1:2), "reproductive",
                                "super reproductive")))
```




```